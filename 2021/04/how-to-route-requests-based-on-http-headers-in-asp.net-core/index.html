<!doctype html><html class=no-js lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="IE=edge">
<title>How to route requests based on HTTP headers in ASP.NET Core - dotNetting</title>
<script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script>
<meta name=description content="This post shows how to route requests to specific actions in ASP.NET Core via implementing IActionConstraint and decorating actions and controllers with an Attribute to indicate the value of a header to determine the valid route to follow.">
<meta property="og:title" content="How to route requests based on HTTP headers in ASP.NET Core">
<meta property="og:description" content="This post shows how to route requests to specific actions in ASP.NET Core via implementing IActionConstraint and decorating actions and controllers with an Attribute to indicate the value of a header to determine the valid route to follow.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://dotnetting.net/2021/04/how-to-route-requests-based-on-http-headers-in-asp.net-core/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-04-29T00:00:00+00:00">
<meta property="article:modified_time" content="2021-04-29T00:00:00+00:00">
<meta itemprop=name content="How to route requests based on HTTP headers in ASP.NET Core">
<meta itemprop=description content="This post shows how to route requests to specific actions in ASP.NET Core via implementing IActionConstraint and decorating actions and controllers with an Attribute to indicate the value of a header to determine the valid route to follow."><meta itemprop=datePublished content="2021-04-29T00:00:00+00:00">
<meta itemprop=dateModified content="2021-04-29T00:00:00+00:00">
<meta itemprop=wordCount content="455">
<meta itemprop=keywords content="asp.net core,csharp,routing,http headers,">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="How to route requests based on HTTP headers in ASP.NET Core">
<meta name=twitter:description content="This post shows how to route requests to specific actions in ASP.NET Core via implementing IActionConstraint and decorating actions and controllers with an Attribute to indicate the value of a header to determine the valid route to follow.">
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link rel=dns-prefetch href=//fonts.googleapis.com>
<link rel=dns-prefetch href=//fonts.gstatic.com>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
<link rel=stylesheet href=/css/style.css>
<link rel=stylesheet href=/css/custom.css>
<link rel="shortcut icon" href=/favicon.ico>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VGT0SY9PT3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-VGT0SY9PT3',{anonymize_ip:!1})}</script>
</head>
<body class=body>
<div class="container container--outer">
<header class=header>
<div class="container header__container">
<div class=logo>
<a class=logo__link href=/ title=dotNetting rel=home>
<div class="logo__item logo__text">
<div class=logo__title>dotNetting</div>
<div class=logo__tagline>netting the cloud with C#</div>
</div>
</a>
</div>
<div class=divider></div>
</div>
</header>
<div class="wrapper flex">
<div class=primary>
<main class=main role=main>
<article class=post>
<header class=post__header>
<h1 class=post__title>How to route requests based on HTTP headers in ASP.NET Core</h1>
<div class="post__meta meta"><div class="meta__item-author meta__item">
<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Lester Sanchez</span>
</div>
<div class="meta__item-datetime meta__item">
<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-04-29T00:00:00Z>2021-04-29</time></div></div>
</header><div class="content post__content clearfix">
<p>It is common for APIs to route requests based on a combination of HTTP verb (GET, POST, etc.) and path. For example, we can have same path <code>/api/items/123</code> for both retrieving the information about item <code>123</code> and deleting item <code>123</code>, using HTTP verbs <code>GET</code> and <code>DELETE</code> respectively. But what if we have the same verb and path and need to route the requests based on the value of a HTTP header?</p>
<h2 id=problem>Problem</h2>
<p>In some situations we may have to expose the same path and HTTP verb to support different behaviour. Imagine we are responsible for maintaining a microservice in a CRM system that uses the <code>Accept</code> header to handle versioning. We need to support the following requests:</p>
<blockquote>
<p><code>Accept: application/vnd.crm.v1+json, GET api/customers/123</code></p>
</blockquote>
<blockquote>
<p><code>Accept: application/vnd.crm.v2+json, GET api/customers/123</code></p>
</blockquote>
<p>Each of those requests produces different results so we want to handle them in different actions. Because the verb and the path are the same, we have to route the request to the right action based on the value of the <code>Accept</code> header.</p>
<h2 id=solution>Solution</h2>
<p>ASP.NET Core introduced the interface <a href=https://docs.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.actionconstraints.iactionconstraint><code>IActionConstraint</code></a> that allows us to determine whether or not an action is applicable for a given request. We can create then an attribute and implement this interface to determine which method to execute based on the value of the <code>Accept</code> header.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AcceptsAttribute</span> : Attribute, IActionConstraint
{
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#66d9ef>string</span> <span style=color:#ae81ff>_</span>acceptHeaderValue;

    <span style=color:#66d9ef>public</span> AcceptsAttribute(<span style=color:#66d9ef>string</span> acceptHeaderValue)
    {
        <span style=color:#ae81ff>_</span>acceptHeaderValue = acceptHeaderValue;
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>bool</span> Accept(ActionConstraintContext context)
    {
        <span style=color:#66d9ef>if</span> (!context.RouteContext.HttpContext.Request.Headers.ContainsKey(<span style=color:#e6db74>&#34;Accept&#34;</span>))
        {
            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
        }

        <span style=color:#66d9ef>var</span> headerValue = context.RouteContext.HttpContext.Request.Headers[<span style=color:#e6db74>&#34;Accept&#34;</span>];
        <span style=color:#66d9ef>return</span> headerValue.Contains(<span style=color:#ae81ff>_</span>acceptHeaderValue);
    }

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> Order =&gt; <span style=color:#ae81ff>0</span>;
}
</code></pre></div><p>And then we can decorate our actions with the new <code>Accepts</code> attribute to indicate the supported version.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#a6e22e>[Route(&#34;api/customers&#34;)]</span>
<span style=color:#a6e22e>[ApiController]</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CustomersController</span> : ControllerBase
{
<span style=color:#a6e22e>    [HttpGet]</span>
<span style=color:#a6e22e>    [Route(&#34;{id}&#34;)]</span>
<span style=color:#a6e22e>    [Accepts(&#34;application/vnd.crm.v1+json&#34;)]</span>
    <span style=color:#66d9ef>public</span> IActionResult GetV1(<span style=color:#66d9ef>int</span> id)
    {
        <span style=color:#75715e>// Implementation omitted for brevity
</span><span style=color:#75715e></span>    }
<span style=color:#a6e22e>
</span><span style=color:#a6e22e>    [HttpGet]</span>
<span style=color:#a6e22e>    [Route(&#34;{id}&#34;)]</span>
<span style=color:#a6e22e>    [Accepts(&#34;application/vnd.crm.v2+json&#34;)]</span>
    <span style=color:#66d9ef>public</span> IActionResult GetV2(<span style=color:#66d9ef>int</span> id)
    {
        <span style=color:#75715e>// Implementation omitted for brevity
</span><span style=color:#75715e></span>    }
}
</code></pre></div><p>You can instead decorate a controller with this attribute, which would mean all the actions in the controller support that version.</p>
<h2 id=final-thoughts>Final thoughts</h2>
<p>In the previous example I used the <code>Accept</code> header, but the solution is valid for any header. Also, the example was showing the use of the attribute to solve the versioning problem, but this can be easily extended to any situation that requires handling requests in a different way, for the same HTTP verb and path.</p>
<p>The example used in this post is not a suggestion that this is the right way to handle API versions. There are certainly different options for that, and the right one would depend on your particular situation. The example was just intended to ilustrate how to route requests based on different header values when the HTTP verb and path are the same.</p>
<p>Keep dotnetting&mldr;</p>
</div>
<footer class=post__footer>
<div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg>
<ul class=tags__list>
<li class=tags__item>
<a class="tags__link btn" href=/tags/asp.net-core/ rel=tag>asp.net core</a>
</li>
<li class=tags__item>
<a class="tags__link btn" href=/tags/csharp/ rel=tag>csharp</a>
</li>
<li class=tags__item>
<a class="tags__link btn" href=/tags/routing/ rel=tag>routing</a>
</li>
<li class=tags__item>
<a class="tags__link btn" href=/tags/http-headers/ rel=tag>http headers</a>
</li>
</ul>
</div>
</footer>
</article>
</main>
<div class="authorbox clearfix">
<figure class=authorbox__avatar>
<img alt="Lester Sanchez avatar" src=/img/avatar.jpg class=avatar height=90 width=90>
</figure>
<div class=authorbox__header>
<span class=authorbox__name>About Lester Sanchez</span>
</div>
<div class=authorbox__description>
I am passionate about Computer Science and Cloud Technologies, working as full-time Software Engineer primarily on the ASP.NET stack. I have worked with different frameworks and languages during the last 15 years, but .NET/C# have been the most beloved pair. I started this blog to share some of my findings, that have been useful to me at some point of my career. I hope they can be useful for you too.
</div>
</div>
<nav class="pager flex">
<div class="pager__item pager__item--next">
<a class=pager__link href=/2021/05/testing-simulate-database-failures-using-ef-core-interceptors/ rel=next>
<span class=pager__subtitle>Next&#8201;Â»</span>
<p class=pager__title>Testing: Simulate database failures using EF Core Interceptors</p>
</a>
</div>
</nav>
<section class=comments>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//dotnetting.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</section>
</div>
</div>
<footer class=footer>
<div class="container footer__container flex">
<div class=footer__copyright>
&copy; 2022 dotNetting.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span>
</div>
</div>
</footer>
</div>
<script async defer src=/js/menu.js></script>
</body>
</html>