<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to do logging in .NET AWS Lambda functions - dotNetting</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content="This post shows four different options to write logs in AWS Lambda functions implemented in .NET and discuses pros and cons of each of them, including examples."><meta property="og:title" content="How to do logging in .NET AWS Lambda functions"><meta property="og:description" content="This post shows four different options to write logs in AWS Lambda functions implemented in .NET and discuses pros and cons of each of them, including examples."><meta property="og:type" content="article"><meta property="og:url" content="https://dotnetting.net/2023/05/how-to-do-logging-in-.net-aws-lambda-functions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-05-25T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-25T00:00:00+00:00"><meta itemprop=name content="How to do logging in .NET AWS Lambda functions"><meta itemprop=description content="This post shows four different options to write logs in AWS Lambda functions implemented in .NET and discuses pros and cons of each of them, including examples."><meta itemprop=datePublished content="2023-05-25T00:00:00+00:00"><meta itemprop=dateModified content="2023-05-25T00:00:00+00:00"><meta itemprop=wordCount content="1337"><meta itemprop=keywords content="dotnet,csharp,aws-lambda,cloudwatch,observability,logging,powertools,serilog,ilogger,"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to do logging in .NET AWS Lambda functions"><meta name=twitter:description content="This post shows four different options to write logs in AWS Lambda functions implemented in .NET and discuses pros and cons of each of them, including examples."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-VGT0SY9PT3"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VGT0SY9PT3",{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=dotNetting rel=home><div class="logo__item logo__text"><div class=logo__title>dotNetting</div><div class=logo__tagline>netting the cloud with C#</div></div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>How to do logging in .NET AWS Lambda functions</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Lester Sanchez</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-05-25T00:00:00Z>2023-05-25</time></div></div></header><div class="content post__content clearfix"><p>This article discusses four different ways of sending logs to <a href=https://aws.amazon.com/cloudwatch/>Cloudwatch</a> from a <a href=https://aws.amazon.com/lambda>Lambda</a> function implemented in .NET.</p><h2 id=using-ilambdacontextlogger>Using ILambdaContext.Logger</h2><p>The <a href=https://github.com/aws/aws-lambda-dotnet/blob/master/Libraries/src/Amazon.Lambda.Core/README.md#ilambdalogger>ILambdaLogger</a> is the most limited option, but it is also the only one readily available in the lambda without requiring any configuration. It just writes messages in one line, without any specific structure. There is no support to add exceptions when logging errors, or using message template with parameters. This is a good option for a very basic logging needs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> FunctionHandler(..., ILambdaContext context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    context.Logger.LogLine(<span style=color:#e6db74>&#34;This is a log entry using ILambdaContext.Logger&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/img/20230524/lambda-context-logger.png alt="LambdaContext Logger"></p><h2 id=using-lambdailogger-as-a-microsoft-ilogger>Using LambdaILogger as a Microsoft ILogger</h2><p><a href=https://github.com/aws/aws-lambda-dotnet/tree/master/Libraries/src/Amazon.Lambda.Logging.AspNetCore#amazonlambdaloggingaspnetcore>LambdaILogger</a> is similar to the previous one. It writes messages in one line, but supports message template and exceptions to some extent. Although be careful when passing non-primitive parameters, as objects are not serialised, but just converted to <code>string</code> calling the <code>ToString()</code> method. Therefore, if the parameter type does not have an impementation for <code>ToString()</code>, default one will be used, which by default returns the name of the type. Not very useful when logging. Another benefit of using Microsoft <code>ILogger</code> are scopes, which allow to enrich multiple log entries with additional properties.</p><p>To use Microsoft <code>ILogger</code> you need to add the <a href=https://www.nuget.org/packages/Amazon.Lambda.Logging.AspNetCore>NuGet package</a> to your project and follow all the dependency injection ceremonies to add and retrieve the <code>ILogger</code> implementation to and from the <code>ServiceCollection</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>&gt; dotnet add package Amazon.Lambda.Logging.AspNetCore
</span></span></code></pre></div><h3 id=extension-methods-to-support-service-instantiation>Extension methods to support service instantiation</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IConfiguration AddConfiguration(<span style=color:#66d9ef>this</span> IServiceCollection services)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> configBuilder = <span style=color:#66d9ef>new</span> ConfigurationBuilder()
</span></span><span style=display:flex><span>        .SetBasePath(Directory.GetCurrentDirectory())
</span></span><span style=display:flex><span>        .AddJsonFile(<span style=color:#e6db74>&#34;appsettings.json&#34;</span>, optional: <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> configBuilder.Build();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IServiceCollection AddLogging(<span style=color:#66d9ef>this</span> IServiceCollection services, IConfiguration configuration)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> services.AddLogging(options =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> loggerOptions = <span style=color:#66d9ef>new</span> LambdaLoggerOptions(configuration);
</span></span><span style=display:flex><span>        options.AddLambdaLogger(loggerOptions);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=configuration-for-lambdalogger-in-appsettingsjson>Configuration for LambdaLogger in appsettings.json</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;Lambda.Logging&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeCategory&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeLogLevel&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeException&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeEventId&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeNewline&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;IncludeScopes&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;LogLevel&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Default&#34;</span>: <span style=color:#e6db74>&#34;Debug&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;System&#34;</span>: <span style=color:#e6db74>&#34;Information&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;Microsoft&#34;</span>: <span style=color:#e6db74>&#34;Information&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>string</span> Name { <span style=color:#66d9ef>get</span>; <span style=color:#66d9ef>set</span>; }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> FunctionHandler(..., ILambdaContext context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add ILogger implementation to the ServiceCollection</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> serviceCollection = <span style=color:#66d9ef>new</span> ServiceCollection();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> configuration = serviceCollection.AddConfiguration();
</span></span><span style=display:flex><span>    serviceCollection.AddLogging(configuration);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get ILogger implementation from ServiceCollection</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> serviceProvider = serviceCollection.BuildServiceProvider();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> var scope = serviceProvider.CreateScope();    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> logger = scope.ServiceProvider.GetRequiredService&lt;ILogger&lt;Function&gt;&gt;();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start a new logging scope</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> var scope = logger.BeginScope(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Dictionary&lt;<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>object</span>&gt; {
</span></span><span style=display:flex><span><span style=color:#a6e22e>            [&#34;DayOfWeek&#34;]</span> = DateTime.Today.DayOfWeek,
</span></span><span style=display:flex><span><span style=color:#a6e22e>            [&#34;MemoryLimitInMB&#34;]</span> = context.MemoryLimitInMB
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    logger.LogInformation(<span style=color:#e6db74>&#34;This is a log entry using LambdaILogger: {FunctionName}, {Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    logger.LogError(<span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>&#34;Something wrong happened...&#34;</span>), <span style=color:#e6db74>&#34;An exception was thown. LambdaILogger&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Alternatively, you can create the logger using the <code>LoggerFactory</code> class, bypassing the ceremonies around the <code>ServiceCollection</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> loggerFactory = LoggerFactory.Create(options =&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> loggerOptions = <span style=color:#66d9ef>new</span> LambdaLoggerOptions
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        IncludeCategory = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        IncludeScopes = <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        IncludeLogLevel = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    options.AddLambdaLogger(loggerOptions);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> logger = loggerFactory.CreateLogger&lt;Function&gt;();
</span></span></code></pre></div><p><img src=/img/20230524/ilogger-info.png alt="ILogger Info">
<img src=/img/20230524/ilogger-exception.png alt="ILogger Error with Exception"></p><p>As shown in the previous screenshot from <em>Cloudwatch</em>, the <code>LambdaILogger</code> relies on the <code>ToString()</code> implementation to convert parameters into strings and embed the values into the log message. Although the Microsoft Logging API supports scopes to enrich logs with additional properties, the <code>LambdaILogger</code> implementation does not support that very well. The <code>Person</code> parameter was completely ignored, and properties in the dictionary used in the scope were not serialised properly.</p><p>If you were to use <code>LambdaILogger</code>, you must take care of serialising the parameters in the scope and the message.</p><h2 id=using-serilog>Using Serilog</h2><p><a href=https://serilog.net/>Serilog</a> can be used directly or through the Microsoft <code>ILogger</code> abstraction. Serilog is a versatile library, highly customisable, therefore it is recomended if you need a high degree of control about the logs format and where to send them. To use Serilog, add the <a href=https://www.nuget.org/packages/Serilog.AspNetCore>NuGet package</a> to your project.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>&gt; dotnet add package Serilog.AspNetCore
</span></span></code></pre></div><h3 id=configuring-serilog>Configuring Serilog</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> IServiceCollection AddLogging(<span style=color:#66d9ef>this</span> IServiceCollection services, IConfiguration configuration)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> LoggerConfiguration()
</span></span><span style=display:flex><span>        .MinimumLevel.Is(LogEventLevel.Debug)
</span></span><span style=display:flex><span>        .Enrich.FromLogContext()
</span></span><span style=display:flex><span>        .WriteTo.Console(<span style=color:#66d9ef>new</span> RenderedCompactJsonFormatter());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Creates the default logger</span>
</span></span><span style=display:flex><span>    Log.Logger = config.CreateLogger();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adds Serilog ILogger provider to ServiceCollection to be used by dependency libraries</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> services.AddLogging(options =&gt;
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        options.AddSerilog(dispose: <span style=color:#66d9ef>true</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> FunctionHandler(..., ILambdaContext context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> logger = Log.ForContext&lt;Function&gt;();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> enrichers = <span style=color:#66d9ef>new</span> ILogEventEnricher[]
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> PropertyEnricher(<span style=color:#e6db74>&#34;DayOfWeek&#34;</span>, DateTime.Today.DayOfWeek),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> PropertyEnricher(<span style=color:#e6db74>&#34;MemoryLimitInMB&#34;</span>, context.MemoryLimitInMB)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> var scope = LogContext.Push(enrichers);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    logger.Information(<span style=color:#e6db74>&#34;This is a log entry using Serilog: {FunctionName}, {Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    logger.Information(<span style=color:#e6db74>&#34;This is a log entry using Serilog: {FunctionName}, {@Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    logger.Error(<span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>&#34;Something wrong happened...&#34;</span>), <span style=color:#e6db74>&#34;An exception was thown. Serilog&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Serilog also has the ability to serialise parameters used in the message template, instead of converting them to string, when name is prefixed with <code>@</code>, like <code>@Person</code> in the example above.</p><p><img src=/img/20230524/serilog.png alt=Serilog></p><p>Unfortunately, to make <em>Cloudwatch</em> to correlate logs and traces in <em>X-Ray</em> I had to tinker with the message format Serilog uses to write the log entries, to make <code>AwsRequestId</code> available in the message in the place and format <em>Cloudwatch</em> is expecting it. I could easily do this using the <code>ExpressionTemplate</code> class, one of the strongest extension points in Serilog.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#66d9ef>var</span> config = <span style=color:#66d9ef>new</span> LoggerConfiguration()
</span></span><span style=display:flex><span>        .MinimumLevel.Is(LogEventLevel.Debug)
</span></span><span style=display:flex><span>        .Enrich.FromLogContext()
</span></span><span style=display:flex><span>        .WriteTo.Console(<span style=color:#66d9ef>new</span> ExpressionTemplate(<span style=color:#e6db74>&#34;{UtcDateTime(@t):o}\t{AwsRequestId}\t{@l}\t{ {@t, @m, @l, @x, ..@p} }\n&#34;</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Log.Logger = config.CreateLogger();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> logger = Log.ForContext&lt;Function&gt;();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> enrichers = <span style=color:#66d9ef>new</span> ILogEventEnricher[]
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> PropertyEnricher(<span style=color:#e6db74>&#34;AwsRequestId&#34;</span>, context.AwsRequestId),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> PropertyEnricher(<span style=color:#e6db74>&#34;DayOfWeek&#34;</span>, DateTime.Today.DayOfWeek),
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> PropertyEnricher(<span style=color:#e6db74>&#34;MemoryLimitInMB&#34;</span>, context.MemoryLimitInMB)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>using</span> var scope = LogContext.Push(enrichers);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    logger.Information(<span style=color:#e6db74>&#34;This is a log entry using Serilog: {FunctionName}, {Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    logger.Information(<span style=color:#e6db74>&#34;This is a log entry using Serilog: {FunctionName}, {@Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    logger.Error(<span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>&#34;Something wrong happened...&#34;</span>), <span style=color:#e6db74>&#34;An exception was thown. Serilog&#34;</span>);
</span></span></code></pre></div><p>As you can see in the screenshot below, despite the log entry not being a full JSON object, <em>Cloudwatch</em> support search expressions on the JSON part.</p><p><img src=/img/20230524/cloudwatch-search-expression.png alt="Cloudwatch search expression"></p><p>And this way <em>Cloudwatch</em> correlates traces in <em>X-Ray</em> with the logs generated by Serilog.</p><p><img src=/img/20230524/traces-logs-correlation.png alt="Logs in X-Ray"></p><h2 id=using-lambda-powertools>Using Lambda Powertools</h2><p>AWS team has created a suite of utilities called <a href=https://awslabs.github.io/aws-lambda-powertools-dotnet/>Powertools</a> tailored for AWS Lambda functions. The tools included in this suite help also with other areas of observability, but I will be focusing here only on <a href=https://github.com/awslabs/aws-lambda-powertools-dotnet/tree/main/examples/Logging/>logging</a>.</p><p>To use this tool in your Lambda you need to add the <a href=https://www.nuget.org/packages/AWS.Lambda.Powertools.Logging>NuGet package</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>&gt; dotnet add package AWS.Lambda.Powertools.Logging
</span></span></code></pre></div><p>Then just apply the <code>Logging</code> attribute to your function handler, as shown in the example below. This is all that is needed to configure and initialise the Logger in Powertools. Very straightforward.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#a6e22e>[Logging(LoggerOutputCase = LoggerOutputCase.PascalCase)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>async</span> Task FunctionHandler(..., ILambdaContext context)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Logger.AppendKey(<span style=color:#e6db74>&#34;Service&#34;</span>, <span style=color:#e6db74>&#34;MyServiceName&#34;</span>);
</span></span><span style=display:flex><span>    Logger.AppendKey(<span style=color:#e6db74>&#34;DayOfWeek&#34;</span>, DateTime.Today.DayOfWeek);
</span></span><span style=display:flex><span>    Logger.AppendKey(<span style=color:#e6db74>&#34;MemoryLimitInMB&#34;</span>, context.MemoryLimitInMB);
</span></span><span style=display:flex><span>    Logger.LogInformation(message: <span style=color:#e6db74>&#34;This is a log entry using Powertools: {FunctionName}, {Person}&#34;</span>, context.FunctionName, <span style=color:#66d9ef>new</span> Person { Name = <span style=color:#e6db74>&#34;The Invisible Man&#34;</span> });
</span></span><span style=display:flex><span>    Logger.LogError(<span style=color:#66d9ef>new</span> Exception(<span style=color:#e6db74>&#34;Something wrong happened...&#34;</span>), <span style=color:#e6db74>&#34;An exception was thown. Powertools&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><img src=/img/20230524/powertools-logger.png alt="Powertools Logger"></p><p>Logs generated by Powertools are written in the format expected by <em>Cloudwatch</em> and are correlated with any traces in <em>X-Ray</em>, via the <code>AwsRequestId</code> identifier, included by default in the log message. Not sure though why Powertools or <em>Cloudwatch</em> renders the level as <code>info</code> when the log level is clearly indicated as <code>Error</code>.</p><h2 id=final-thoughts>Final thoughts</h2><p>When it comes to logs, consistency is important when you have multiple applications and services generating logs in a distributed architecture. You want your logs to be searcheable, filterable and human readable to some extent. JSON structured logs seem to fit well in that description, and this is something both Powertools and Serilog provide. The decision about which of these two depends on your scenario.</p><p>If you want a quick, simple and convenient way of sending logs to <em>Cloudwatch</em>, then Powertools might be your choice. Just understand this is specific for AWS Lambda functions, and logs format is not too flexible; but this could be good enough for you.</p><p>If you need more control and flexibility on the format and structure of the logs, then you will be better off with Serilog. Another advantage of using Serilog is that it can be wrapped by a Logger Provider and used via the <code>ILogger</code> abstraction provided by Microsoft. The biggest benefit of this being that logs written by dependency libraries using the <code>ILogger</code> abstraction will follow the same format and contain the same common properties within the scope. Therefore, consistent logs all the way, easier to search, filter and correlate.</p><p>Keep dotnetting&mldr;</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/dotnet/ rel=tag>dotnet</a></li><li class=tags__item><a class="tags__link btn" href=/tags/csharp/ rel=tag>csharp</a></li><li class=tags__item><a class="tags__link btn" href=/tags/aws-lambda/ rel=tag>aws-lambda</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cloudwatch/ rel=tag>cloudwatch</a></li><li class=tags__item><a class="tags__link btn" href=/tags/observability/ rel=tag>observability</a></li><li class=tags__item><a class="tags__link btn" href=/tags/logging/ rel=tag>logging</a></li><li class=tags__item><a class="tags__link btn" href=/tags/powertools/ rel=tag>powertools</a></li><li class=tags__item><a class="tags__link btn" href=/tags/serilog/ rel=tag>serilog</a></li><li class=tags__item><a class="tags__link btn" href=/tags/ilogger/ rel=tag>ilogger</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Lester Sanchez avatar" src=/img/avatar.jpg class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Lester Sanchez</span></div><div class=authorbox__description>I am passionate about Computer Science and Cloud Technologies, working as full-time Software Engineer primarily on the ASP.NET stack. I have worked with different frameworks and languages during the last 15 years, but .NET/C# have been the most beloved pair. I started this blog to share some of my findings, that have been useful to me at some point of my career. I hope they can be useful for you too.</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/2022/01/how-to-use-visual-studio-without-docker-desktop-to-debug-a-.net-core-application-running-in-a-container-inside-wsl/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>How to use Visual Studio without Docker Desktop to debug a .NET Core application running in a container inside WSL</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//dotnetting.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2023 dotNetting.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script></body></html>